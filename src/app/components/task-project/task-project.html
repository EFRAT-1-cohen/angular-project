<div class="task-dashboard">

  @if (isLoadingTasks()) {
    <div class="loading-spinner-center">
      <mat-spinner diameter="60"></mat-spinner>
      <p>×˜×•×¢×Ÿ ××ª ×”××©×™××•×ª...</p>
    </div>
  }

  @if (error()) {
    <div class="error-banner">
      <mat-icon>error_outline</mat-icon>
      <span>{{ error() }}</span>
      <button mat-icon-button (click)="error.set(null)">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  }

  @if (!isLoadingTasks()) {
    <header class="dashboard-header">
      <div class="header-text">
        <span class="badge-project">PROJECT #{{ currentProjectId }}</span>
        <h1>×œ×•×— ××©×™××•×ª</h1>
        <p>× ×”×œ ××ª ×”××©×™××•×ª ×©×œ×š ×‘×™×¢×™×œ×•×ª ×•×‘×¡×˜×™×™×œ</p>
      </div>
      
      <button mat-flat-button class="btn-gradient-primary" (click)="toggleAddForm()" 
              [disabled]="isCreatingTask() || isUpdatingTask()">
        <mat-icon>{{ isFormADDExpanded() ? 'close' : 'add' }}</mat-icon>
        {{ isFormADDExpanded() ? '×¡×’×•×¨ ×˜×•×¤×¡' : '××©×™××” ×—×“×©×”' }}
      </button>
    </header>

    <div class="form-container" [class.open]="isFormADDExpanded()">
      <div class="glass-panel">
        <h3>{{ isEditing() ? 'âœï¸ ×¢×¨×™×›×ª ××©×™××”' : 'âœ¨ ×™×¦×™×¨×ª ××©×™××” ×—×“×©×”' }}</h3>
        
        <form [formGroup]="isEditing() ? updateTaskForm : taskForm" 
              (ngSubmit)="isEditing() ? onUpdateTask() : onSubmitADD()">
          <div class="form-grid">
            
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>×›×•×ª×¨×ª ×”××©×™××”</mat-label>
              <mat-icon matPrefix class="icon-gradient">title</mat-icon>
              <input matInput formControlName="title" [disabled]="isCreatingTask() || isUpdatingTask()">
            </mat-form-field>

            <div class="row-inputs">
              <mat-form-field appearance="outline">
                <mat-label>×¡×˜×˜×•×¡</mat-label>
                <mat-select formControlName="status" [disabled]="isCreatingTask() || isUpdatingTask()">
                  <mat-option value="todo">ğŸ“‹ ×œ×‘×™×¦×•×¢</mat-option>
                  <mat-option value="in_progress">ğŸš€ ×‘×ª×”×œ×™×š</mat-option>
                  <mat-option value="done">âœ… ×”×•×©×œ×</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>×¢×“×™×¤×•×ª</mat-label>
                <mat-select formControlName="priority" [disabled]="isCreatingTask() || isUpdatingTask()">
                  <mat-option value="low">ğŸŸ¢ × ××•×›×”</mat-option>
                  <mat-option value="normal">ğŸ”µ ×¨×’×™×œ×”</mat-option>
                  <mat-option value="high">ğŸ”´ ×“×—×•×¤×”</mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <div class="row-inputs">
              <mat-form-field appearance="outline">
                <mat-label>×ª××¨×™×š ×™×¢×“</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="dueDate" [disabled]="isCreatingTask() || isUpdatingTask()">
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>××–×”×” ××—×¨××™ (ID)</mat-label>
                <input matInput type="number" formControlName="assigneeId" [disabled]="isCreatingTask() || isUpdatingTask()">
                <mat-icon matSuffix>person</mat-icon>
              </mat-form-field>
            </div>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>×ª×™××•×¨ ×”××©×™××”</mat-label>
              <textarea matInput formControlName="description" rows="3" [disabled]="isCreatingTask() || isUpdatingTask()"></textarea>
            </mat-form-field>

          </div>

          <div class="form-actions">
            <button mat-button type="button" (click)="toggleAddForm()" [disabled]="isCreatingTask() || isUpdatingTask()">×‘×™×˜×•×œ</button>
            <button mat-flat-button class="btn-submit" type="submit" 
                    [disabled]="(isEditing() ? updateTaskForm.invalid : taskForm.invalid) || isCreatingTask() || isUpdatingTask()">
              @if (isCreatingTask() || isUpdatingTask()) {
                {{ isEditing() ? '×©×•××¨...' : '×™×•×¦×¨...' }}
              } @else {
                {{ isEditing() ? '×©××•×¨ ×©×™× ×•×™×™×' : '×¦×•×¨ ××©×™××”' }}
              }
            </button>
          </div>
        </form>
      </div>
    </div>

    <main class="tasks-grid">
      @if (task$ | async; as tasks) {
        @for (task of tasks; track task.id) {
          
          <div class="task-card" [class]="'priority-' + task.priority">
            <div class="card-top">
              <div class="status-chip" [class]="task.status">
                @if(task.status === 'todo') { ğŸ“‹ ×œ×‘×™×¦×•×¢ }
                @else if(task.status === 'in_progress') { ğŸš€ ×‘×ª×”×œ×™×š }
                @else { âœ… ×”×•×©×œ× }
              </div>
              
              <button mat-icon-button [matMenuTriggerFor]="menu" [disabled]="isDeletingTask() || isUpdatingTask()">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #menu="matMenu">
                <button mat-menu-item (click)="onEditClick(task)" [disabled]="isDeletingTask() || isUpdatingTask()">
                  <mat-icon>edit</mat-icon>
                  <span>×¢×¨×•×š</span>
                </button>
                <button mat-menu-item (click)="onSubmitDelete(task.id)" class="delete-item" [disabled]="isDeletingTask() || isUpdatingTask()">
                  <mat-icon color="warn">delete</mat-icon>
                  <span>{{ isDeletingTask() ? '××•×—×§...' : '××—×§' }}</span>
                </button>
              </mat-menu>
            </div>

            <h3 class="task-title">{{ task.title }}</h3>
            <p class="task-desc">{{ task.description || '××™×Ÿ ×ª×™××•×¨ ×œ××©×™××” ×–×•' }}</p>

            <div class="card-footer">
              <div class="info-group">
                <mat-icon class="mini-icon">event</mat-icon>
                <span>{{ task.due_date | date:'dd/MM' }}</span>
              </div>
              
              <button mat-button class="btn-comments" (click)="openComments(task.id)" [disabled]="isDeletingTask() || isUpdatingTask() || isCreatingTask()">
                <mat-icon>chat_bubble_outline</mat-icon>
                <span>×ª×’×•×‘×•×ª</span>
              </button>
              
              <div class="assignee-avatar">
                {{ task.assignee_id || '?' }}
              </div>
            </div>
          </div>
        } @empty {
          <div class="empty-state">
            <mat-icon>assignment_turned_in</mat-icon>
            <h3>××™×Ÿ ××©×™××•×ª ×¢×“×™×™×Ÿ</h3>
            <p>×”×ª×—×œ ×‘×™×¦×™×¨×ª ×”××©×™××” ×”×¨××©×•× ×” ×©×œ×š!</p>
          </div>
        }
      }
    </main>
  }
</div>